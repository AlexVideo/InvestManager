# План: новые столбцы, строка состояния, настройки столбцов

---

## 1. Два новых столбца в таблице проектов (режим «Инвест»)

### 1.1. «Заложено изначально»
- **Смысл:** сумма, которая изначально выделена по статье (поле `budget` из БД).
- **Откуда данные:** при заполнении таблицы уже приходит `base_budget` из `list_projects()` (это и есть `budget`). Нужно вывести его в отдельном столбце.
- **Где:** логически между «Участок» и «Имеется» (или в другом месте по итоговому порядку столбцов).

### 1.2. «Процент исполнения от изначального»
- **Формула:** при `budget > 0`: **Исполн. % = (Имеется / Заложено изначально) × 100** (один знак после запятой).
- **Когда показывать значение:** «появляется, когда есть договор» — интерпретация: показывать процент, если по статье есть хотя бы одна запись «Договор» (т.е. `contract_amount` не 0), иначе в ячейке «—».
- **Откуда данные:** «Имеется» = `status["have"]`, «Заложено» = `budget`; факт наличия договора — `status["contract_amount"]` (или отдельный запрос при необходимости).

**Итог по столбцам (логический состав):**  
Название, Рудник, Участок, **Заложено изначально**, Имеется, Необходимо, Маркетинг, Договор, Остаток, **Исполн. %**, Вне бюджета → **11 столбцов**.

---

## 2. Строка состояния внизу окна (только режим «Инвест»)

- **Расположение:** под таблицей (и под фильтрами), внизу главного окна — одна строка (виджет с текстом).
- **Что выводить (три величины):**
  1. **Заложено (всего):** сумма по столбцу «Заложено изначально» по всем статьям. Это текущий бюджет с учётом корректировок (в БД — поле `budget` по каждой статье; корректировки его уже изменили). Формат: **100 000 000 ₸**.
  2. **По договорам исполнено:** сумма по столбцу «Договор» по всем статьям (сколько уже исполнено по договорам в деньгах). Формат: **40 000 000 ₸**.
  3. **Процент:** (по договорам исполнено) / (заложено) × 100. Если заложено = 0, показывать «—» или 0%. Формат: **40%** (один знак после запятой при необходимости).
- **Пример текста в строке состояния:**  
  **«Заложено: 100 000 000 ₸ | По договорам исполнено: 40 000 000 ₸ | 40%»**
- **Откуда данные:** при обновлении таблицы уже считаются `compute_project_status(pid)` по каждому проекту — там есть `contract_amount` и в списке проектов есть `budget`. Для строки состояния нужно просуммировать по всем проектам: `sum(budget)` и `sum(contract_amount)`.

---

## 3. Настройки: видимость и порядок столбцов

### 3.1. Кнопка «Настройки» вместо «О программе»
- **Сейчас:** кнопка **«?»** открывает окно «О программе».
- **Сделать:** заменить кнопку **«?»** на кнопку **«⚙ Настройки»** (или иконка шестерёнки). Окно «О программе» не удалять: открывать его из настроек (вкладка «О программе» или кнопка/ссылка внизу диалога настроек).

### 3.2. Диалог «Настройки»
- **Вкладка (или единственный блок): «Столбцы таблицы»**
  - Список всех столбцов таблицы проектов (11 пунктов после добавления двух новых).
  - У каждого пункта: **галочка** «Показывать» (вкл/выкл = столбец виден/скрыт).
  - Сохранение: кнопка «ОК» (применить и закрыть) и «Отмена».

### 3.3. Изменение порядка столбцов
- В том же диалоге: возможность **менять порядок** пунктов в списке (например, кнопки «Вверх» / «Вниз» или перетаскивание строк).
- Порядок пунктов в списке = порядок столбцов в таблице слева направо.
- После «ОК» таблица перестраивается: заголовки и данные выводятся в сохранённом порядке, скрытые столбцы не отображаются.

### 3.4. Хранение настроек
- **QSettings** (как уже используется для путей к базам): сохранять под ключами, например:
  - `columns/visible` — список флагов видимости по идентификаторам столбцов (или список id видимых).
  - `columns/order` — список идентификаторов столбцов в нужном порядке.
- Идентификаторы столбцов: стабильные строки (`name`, `mine`, `section`, `budget`, `have`, `need`, `marketing`, `contract`, `remainder`, `exec_pct`, `out_of_budget`), чтобы при добавлении новых столбцов настройки не ломались.
- При первом запуске или отсутствии настроек — порядок и видимость по умолчанию (все видимы, порядок как в коде).

---

## 4. Технические шаги в коде (кратко)

| № | Задача | Где |
|---|--------|-----|
| 1 | Добавить два столбца: «Заложено изначально», «Исполн. %». В `refresh()` заполнять их; для «Исполн. %» показывать «—», если договора нет. | `main_window.py`: таблица 11 колонок, логика заполнения, привязка фильтров/сортировки к новым индексам. |
| 2 | Для строки состояния: при каждом refresh() посчитать сумму `budget` по всем проектам и сумму `contract_amount` по всем проектам (данные уже есть в цикле по list_projects + compute_project_status). | `main_window.py`: в refresh() накапливать две суммы, передать их в виджет строки состояния. |
| 3 | Добавить виджет строки состояния под таблицей, обновлять его в `refresh()` (деньги + процент). | `main_window.py`: виджет (QLabel или statusBar), вызов обновления из `refresh()`. |
| 4 | Заменить кнопку «?» на «Настройки», открывать диалог настроек. В диалоге — блок «О программе» (текст из текущего About). | `main_window.py`: кнопка, вызов диалога. |
| 5 | Реализовать диалог настроек: список столбцов с галочками и возможностью менять порядок (Вверх/Вниз или drag-and-drop). Сохранение в QSettings. | Новый файл `settings_dialog.py` (или в `main_window`). |
| 6 | При построении таблицы и заполнении данных использовать сохранённые «порядок» и «видимость» столбцов: создавать столбцы в нужном порядке, скрывать ненужные через `setColumnHidden`. | `main_window.py`: инициализация таблицы и `refresh()` по настройкам. |
| 7 | Адаптировать фильтры и сортировку под изменяемый набор и порядок столбцов (маппинг «логический столбец» ↔ индекс на экране). | `main_window.py`: фильтры по логическим полям (have, need, …), сортировка по логическому столбцу. |

---

## 5. Итог для пользователя

- В таблице появятся столбцы **«Заложено изначально»** и **«Исполн. %»** (процент от заложенного, показывается при наличии договора).
- Внизу окна — **строка состояния**: заложено всего (с учётом корректировок), по договорам исполнено (в деньгах), процент исполнения (исполнено / заложено × 100).
- Кнопка **«Настройки»** откроет диалог, где можно **включать/выключать** отображение столбцов и **менять их порядок**; настройки сохраняются между запусками. Окно «О программе» доступно из того же диалога настроек.

Если такой план подходит, можно переходить к изменениям в коде по шагам выше.
